{"version":3,"file":"index.04913383.js","sources":["../../packages/webaudio/clockworker.mjs","../../packages/webaudio/scheduler.mjs"],"sourcesContent":["/*\nclockworker.mjs - <short description TODO>\nCopyright (C) 2022 Strudel contributors - see <https://github.com/tidalcycles/strudel/blob/main/packages/webaudio/clockworker.mjs>\nThis program is free software: you can redistribute it and/or modify it under the terms of the GNU Affero General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version. This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Affero General Public License for more details. You should have received a copy of the GNU Affero General Public License along with this program.  If not, see <https://www.gnu.org/licenses/>.\n*/\n\n// helpers to create a worker dynamically without needing a server / extra file\nconst stringifyFunction = (func) => '(' + func + ')();';\nconst urlifyFunction = (func) => URL.createObjectURL(new Blob([stringifyFunction(func)], { type: 'text/javascript' }));\nconst createWorker = (func) => new Worker(urlifyFunction(func));\n\n// this is just a setInterval with a counter, running in a worker\nexport class ClockWorker {\n  worker;\n  interval = 0.1; // query span\n  tick = 0;\n  constructor(callback, interval = this.interval) {\n    this.interval = interval;\n    this.worker = createWorker(() => {\n      // we cannot use closures here!\n      let interval;\n      let timerID = null; // this is clock #1 (the sloppy js clock)\n      const clear = () => {\n        if (timerID) {\n          clearInterval(timerID);\n          timerID = null;\n        }\n      };\n      const start = () => {\n        clear();\n        if (!interval) {\n          throw new Error('no interval set! call worker.postMessage({interval}) before starting.');\n        }\n        postMessage('tick');\n        timerID = setInterval(() => postMessage('tick'), interval * 1000);\n      };\n      self.onmessage = function (e) {\n        if (e.data == 'start') {\n          start();\n        } else if (e.data.interval) {\n          interval = e.data.interval;\n          if (timerID) {\n            start();\n          }\n        } else if (e.data == 'stop') {\n          clear();\n        }\n      };\n    });\n    this.worker.postMessage({ interval });\n    // const round = (n, d) => Math.round(n * d) / d;\n    this.worker.onmessage = (e) => {\n      if (e.data === 'tick') {\n        // callback with query span, using clock #2 (the audio clock)\n        callback(this.tick++, this.interval);\n      }\n    };\n  }\n  start() {\n    // console.log('start...');\n    this.worker.postMessage('start');\n  }\n  stop() {\n    // console.log('stop...');\n    this.worker.postMessage('stop');\n    this.tick = 0;\n  }\n  setInterval(interval) {\n    this.worker.postMessage({ interval });\n  }\n}\n","/*\nscheduler.mjs - <short description TODO>\nCopyright (C) 2022 Strudel contributors - see <https://github.com/tidalcycles/strudel/blob/main/packages/webaudio/scheduler.mjs>\nThis program is free software: you can redistribute it and/or modify it under the terms of the GNU Affero General Public License as published by the Free Software Foundation, either version 3 of the License, or (at your option) any later version. This program is distributed in the hope that it will be useful, but WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU Affero General Public License for more details. You should have received a copy of the GNU Affero General Public License along with this program.  If not, see <https://www.gnu.org/licenses/>.\n*/\n\nimport { ClockWorker } from './clockworker.mjs';\n\nexport class Scheduler {\n  worker;\n  pattern;\n  phase;\n  audioContext;\n  cps = 1;\n  constructor({ audioContext, interval = 0.1, onEvent, latency = 0.1 }) {\n    this.audioContext = audioContext;\n    this.worker = new ClockWorker((tick, interval) => {\n      const begin = this.phase;\n      const end = this.phase + interval * this.cps;\n      this.phase = end;\n      const haps = this.pattern.queryArc(begin, end);\n      haps.forEach((e) => {\n        if (typeof e.value?.cps === 'number') {\n          this.setCps(e.value?.cps);\n        }\n        if (!e.part.begin.equals(e.whole.begin)) {\n          return;\n        }\n        if (e.context.onTrigger) {\n          const ctxTime = (e.whole.begin - begin) / this.cps + this.audioContext.currentTime + latency;\n          e.context.onTrigger(ctxTime, e, this.audioContext.currentTime, this.cps);\n        }\n        if (onEvent) {\n          onEvent?.(e);\n        }\n      });\n    }, interval);\n  }\n  start() {\n    if (!this.pattern) {\n      throw new Error('Scheduler: no pattern set! call .setPattern first.');\n    }\n    this.audioContext.resume();\n    this.phase = 0;\n    this.worker.start();\n  }\n  stop() {\n    this.worker.stop();\n  }\n  setPattern(pat) {\n    this.pattern = pat;\n  }\n  setCps(cps = 1) {\n    this.cps = cps;\n  }\n}\n"],"names":[],"mappings":"iQAOA,KAAM,GAAoB,AAAC,GAAS,IAAM,EAAO,OAC3C,EAAiB,AAAC,GAAS,IAAI,gBAAgB,GAAI,MAAK,CAAC,EAAkB,CAAI,CAAC,EAAG,CAAE,KAAM,iBAAiB,CAAE,CAAC,EAC/G,EAAe,AAAC,GAAS,GAAI,QAAO,EAAe,CAAI,CAAC,EAGvD,MAAM,CAAY,CAIvB,YAAY,EAAU,EAAW,KAAK,SAAU,CAHhD,iBACA,kBAAW,IACX,cAAO,GAEL,KAAK,SAAW,EAChB,KAAK,OAAS,EAAa,IAAM,CAE/B,GAAI,GACA,EAAU,KACd,KAAM,GAAQ,IAAM,CAClB,AAAI,GACF,eAAc,CAAO,EACrB,EAAU,KAEpB,EACY,EAAQ,IAAM,CAElB,GADA,IACI,CAAC,EACH,KAAM,IAAI,OAAM,uEAAuE,EAEzF,YAAY,MAAM,EAClB,EAAU,YAAY,IAAM,YAAY,MAAM,EAAG,EAAW,GAAI,CACxE,EACM,KAAK,UAAY,SAAU,EAAG,CAC5B,AAAI,EAAE,MAAQ,QACZ,IACK,AAAI,EAAE,KAAK,SAChB,GAAW,EAAE,KAAK,SACd,GACF,KAEO,EAAE,MAAQ,QACnB,GAEV,CACA,CAAK,EACD,KAAK,OAAO,YAAY,CAAE,UAAU,CAAA,EAEpC,KAAK,OAAO,UAAY,AAAC,GAAM,CAC7B,AAAI,EAAE,OAAS,QAEb,EAAS,KAAK,OAAQ,KAAK,QAAQ,CAE3C,CACG,CACD,OAAQ,CAEN,KAAK,OAAO,YAAY,OAAO,CAChC,CACD,MAAO,CAEL,KAAK,OAAO,YAAY,MAAM,EAC9B,KAAK,KAAO,CACb,CACD,YAAY,EAAU,CACpB,KAAK,OAAO,YAAY,CAAE,UAAU,CAAA,CACrC,CACH,CC9DO,MAAM,CAAU,CAMrB,YAAY,CAAE,eAAc,WAAW,GAAK,UAAS,UAAU,IAAO,CALtE,iBACA,kBACA,gBACA,uBACA,aAAM,GAEJ,KAAK,aAAe,EACpB,KAAK,OAAS,GAAI,GAAY,CAAC,EAAM,IAAa,CAChD,KAAM,GAAQ,KAAK,MACb,EAAM,KAAK,MAAQ,EAAW,KAAK,IACzC,KAAK,MAAQ,EAEb,AADa,KAAK,QAAQ,SAAS,EAAO,CAAG,EACxC,QAAQ,AAAC,GAAM,SAIlB,GAHI,MAAO,MAAE,QAAF,cAAS,MAAQ,UAC1B,KAAK,OAAO,KAAE,QAAF,cAAS,GAAG,EAEtB,EAAC,EAAE,KAAK,MAAM,OAAO,EAAE,MAAM,KAAK,EAGtC,IAAI,EAAE,QAAQ,UAAW,CACvB,KAAM,GAAW,GAAE,MAAM,MAAQ,GAAS,KAAK,IAAM,KAAK,aAAa,YAAc,EACrF,EAAE,QAAQ,UAAU,EAAS,EAAG,KAAK,aAAa,YAAa,KAAK,GAAG,CACxE,CACD,AAAI,GACF,YAAU,IAEpB,CAAO,CACF,EAAE,CAAQ,CACZ,CACD,OAAQ,CACN,GAAI,CAAC,KAAK,QACR,KAAM,IAAI,OAAM,oDAAoD,EAEtE,KAAK,aAAa,SAClB,KAAK,MAAQ,EACb,KAAK,OAAO,OACb,CACD,MAAO,CACL,KAAK,OAAO,MACb,CACD,WAAW,EAAK,CACd,KAAK,QAAU,CAChB,CACD,OAAO,EAAM,EAAG,CACd,KAAK,IAAM,CACZ,CACH"}